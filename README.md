# Hand Track Pipeline
On this 26th day of September in the 2024th year of our Lord we thus erect the readme of the Hand Track Pipeline. In this document will be found brief descriptions of each module, as well as the output types, formats and locations.
## A Few Things to Begin With
- There is a file called ```config``` in the main directory, this is where most, if not all, of the global vairables should be set-- the directories of where different code bases the pipeline uses are, as well as the prefix for the dlt coefficients that will be used for 3d triangulation.
- There are a few folders in this mian directory of note (in alphabetical order):
  - **checkerboard_calib** : This is where checkerboard calibrations for the cameras should be stored. Ideally the proper calibration will be automatically selected by the code, based on date ranges, however this has not been done yet so the config file should be updated as needed. If new ones need added the conditional statement that selects them should be updated. At the time of this writing there are two, one for pre 220914 dates and one for post 220914 dates.
  - **dlt_coeffs** : This is where the dlt coeffs are stored, same as above there should be code to select the correct ones, but as more are added it must be updated. The code is written to look for a 'prefix' whihc will be the name of the folder the coeffs are in. In each folder there should be a file ```dltCoefs.csv``` with the coeffs and another called ```columns.csv``` which indicates which column goes to each camera. It is important that this is correct as the code will automatically reorganize the dlt coeffs to match the given day based on these columns.
  - **metadata** : This is where the metadata files for each day are stored, segmented by animal name. These are mostly autogenerated, but if there is a specific thing you want to do (i.e. only do a subset of trial in a given day, or if it is a wand day) they can be edited manually.
  - **models** : This stores the DLC models that have been trained, you can alter the config file to user whichever model suits the need. There is currently one model in here that has been working for behavior days (traine don data from both monkeys across a wide range of days) and another for wands (traine don wands from 220914-221015), named respectively.
  - **pipeline-modules** : Contains all the code for the scripts that make up the modules of the pipeline. Each script comes equipped with a description of useage and options.
  - **pipeline-scripts** : some scripts that the modules use, as well as some other scripts for organizing files and such. ```align_wand.py``` is particularly useful for moving labelled wand data to another day (i.e. the checkerboard day) and trackign camera alignment.
  - **setup** : The bulk of packages and libraries used by the pipeline are here. They are relatively static. The environments needed for the pipeline can be built automatically during the env-setup module from these source files. May need to manually add some python libraries on the road, but most deps are handled here.
  - **supp_reg_pts** : A folder for any supplemental points you want to add to the regression data. Currently only supports one feature data and one ground truth data file. I haven't had much success with doing this.
  - **temp_matlab_files** : This can be mostly ignore, it is just a folder for storing intermediate data processed in Python for triangulation in the easyWand package in Matlab and then passed back to Python and automatically deleted. If this process is interupted in the middle, you must manually delete these files and begin again.
  - **visualization_nbs** : Just a few nbs for visualizing the data quickly, and for debugging various plotting and transformation elements. ```apply_dlt_qr.ipynb``` has some good 3D plots for trouble shooting dlt coefficient shenanigans. You can traingulate in matalb and upload the data to this notebook to take a look.
  - **wand_calibration** : I don't think this actualkly gets used but I forget.
  - **wand_data** : I also don't think this gets used.
  - **Other files** :
    - ```notrain_run_script.sh``` : Useful script for running a day automatically, both individual sessions/expts and also a loop for all sessions/expts on a given day.
    - ```wands_all.sh``` : Runs labelling and extraction of wand pts for a list of days.
    - ```wrapperwrapper.sh``` : Calls ```notrain_run_script``` for a list of dates
## Brief description of modules
If more info needed, run the module with a --help flag, for options and usage.
- **env-setup** : Sets up the environments needed for the pipeline, is not exhaustive so some manually additions will need made.
  - Outputs: Shiny new environments.
- **init** : Creates metadata files and directories for a given session
  - Outputs : Links data from server (optional) and makes dirs for each camera, also metadat file in expt directory and metadata file in pipeline metadata.
- **checkerb** : Runs checkerboard for given day, some manual setup is required to make the dirs.
  - Ouputs : Checkerboard calibration matrix and also undistorted frames for review to given cameras folder.
- **dlc-setup** : Should be run before any DLC modules, will intialize and organize data for DLC analysis. Read options carefully based on your use needs. Includes labelling GUI if new model will be trained.
  - Creates DLC project, config file, and directories in expt/behavior/DLC.
- **train** : Module to train a new DLC module. Has a few steps for evaluation and analysis and requires some user labelling in DLC GUI if you want to refine labels.
  - Ouputs : Makes folders for model in expt/behavior/DLC, and various stages of analysis
- **analyze** : Main module for model evaluation and data analysis. Can be used with bespoke model or general model. --skiplink flag will determine this. At the end a labelling GUI will appear for user input on quality of labels.
  - Outputs : Makes folders for model and various steps of analysis in expt/behavior/dlc/combined.../
- **wand** : Purported last step in the pipeline, does all the data extractions, transformations, and plotting. Has a few steps, some can be skipped if you already have dlt coeffs for example.
  - Outputs : folder in /behavior/DLC with extracted campy and DLC data and folder in expt/figures. There are a number of figures here, organuized by trial each is pretty self explanatory. fig 3 and 4 are particualrly useful for a quick look at how the analysis went. Also folder with jump_quant figures for each file. This quantifies the jumps in cam data to ensure DLC labels are sane.

